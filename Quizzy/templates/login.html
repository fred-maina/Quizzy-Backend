{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'Quizzy/css/login.css' %}">
<meta name="csrf-token" content="{{ csrf_token }}">

<div class="container mt-5">
    <div id="login-form" class="login-form mx-auto p-4 border rounded bg-white">
        <div class="text-center">
            <img src="{% static 'Quizzy/images/SecondaryLogo.png' %}" alt="Logo" class="form-logo">
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="email" placeholder="Enter your email">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" placeholder="Enter your password">
            </div>
            <button type="submit" class="btn btn-primary w-100">Sign In</button>
            <div class="mt-3 text-center">
                <a href="#" class="text-decoration-none">Forgot Password?</a>
            </div>
            <div class="mt-3 text-center">
                <span>No account?</span>
                <a href="#" class="text-decoration-none" id="toggle-signup">Sign up</a>
            </div>
        </form>
    </div>

    <div id="signup-form" class="signup-form mx-auto p-4 border rounded bg-white d-none">
        <div class="text-center">
            <img src="{% static 'Quizzy/images/SecondaryLogo.png' %}" alt="Logo" class="form-logo">
        </div>
        <form id="signupForm">
            <div class="mb-3">
                <label for="first-name" class="form-label">First Name</label>
                <input type="text" class="form-control" id="first-name" placeholder="Enter your first name">
            </div>
            <div class="mb-3">
                <label for="last-name" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="last-name" placeholder="Enter your last name">
            </div>
            <div class="mb-3">
                <label for="signup-email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="signup-email" placeholder="Enter your email">
            </div>
            <div class="mb-3">
                <label for="signup-password" class="form-label">Password</label>
                <input type="password" class="form-control" id="signup-password" placeholder="Enter your password">
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="terms">
                <label class="form-check-label" for="terms">I accept the <a href="#" class="text-decoration-none">terms and conditions</a></label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Sign Up</button>
            <div class="mt-3 text-center">
                <span>Already have an account?</span>
                <a href="#" class="text-decoration-none" id="toggle-login">Sign in</a>
            </div>
        </form>
    </div>
</div>

<script>
    // Function to get CSRF token from meta tag
    function getCSRFToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    // Toggle between login and signup forms
    document.getElementById('toggle-signup').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('login-form').classList.add('d-none');
        document.getElementById('signup-form').classList.remove('d-none');
    });

    document.getElementById('toggle-login').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('signup-form').classList.add('d-none');
        document.getElementById('login-form').classList.remove('d-none');
    });

    // Signup form submission
    document.getElementById('signupForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const firstName = document.getElementById('first-name').value.trim();
        const lastName = document.getElementById('last-name').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value.trim();
        const termsAccepted = document.getElementById('terms').checked;
        const csrftoken = getCSRFToken();

        // Validate terms acceptance
        if (!termsAccepted) {
            alert('You must accept the terms and conditions.');
            return;
        }

        // Prepare signup payload
        const signupPayload = {
            username: email,
            password: password,
            email: email,
            first_name: firstName,
            last_name: lastName
        };

        // Perform fetch request to register endpoint
        fetch('/authenticate/register/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(signupPayload)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Signup failed');
            }
            return response.json();
        })
        .then(data => {
            console.log('Signup success data:', data);
            if (data.id) {
                alert('Signup successful');
                document.getElementById('toggle-login').click(); // Switch to login form
            } else {
                throw new Error('Signup failed: Unknown error');
            }
        })
        .catch(error => {
            console.error('Signup error:', error);
            alert(error.message);
        });
    });

    // Login form submission
    document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const csrftoken = getCSRFToken();

        // Prepare login payload
        const loginPayload = {
            username: email,
            password: password
        };

        // Perform fetch request to login endpoint
        fetch('/authenticate/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(loginPayload)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Login failed');
            }
            return response.json();
        })
        .then(data => {
            console.log('Login success data:', data);
            document.cookie = `access=${data.access}; path=/; httponly`;
            window.location.href = '/dashboard/'; // Redirect to dashboard after successful login
        })
        .catch(error => {
            console.error('Login error:', error);
            alert('Login failed: ' + error.message);
        });
    });

</script>

{% endblock %}
